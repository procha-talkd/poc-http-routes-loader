services:
  httpbin:
    image: kennethreitz/httpbin
    ports:
      - "8081:80"
    container_name: httpbin
    networks:
      - gateway-network

  route-server:
    build:
      context: .
      dockerfile: Dockerfile.route-server
    ports:
      - "9090:9090"
    container_name: route-server
    networks:
      - gateway-network
    volumes:
      - ./routes.yaml:/app/routes.yaml

  gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    ports:
      - "8080:8080"
    container_name: gateway
    networks:
      - gateway-network
    environment:
      - GATEWAY_ROUTES_URL=http://route-server:9090/routes.yaml
      - GATEWAY_ROUTES_REFRESH_INTERVAL=5000
    depends_on:
      - httpbin
      - route-server

  vegeta:
    build:
      context: .
      dockerfile: Dockerfile.vegeta
    container_name: vegeta-tester
    networks:
      - gateway-network
    environment:
      - GATEWAY_URL=http://gateway:8080
      - TARGET=/get
      - RATE=100
    depends_on:
      - gateway
    volumes:
      - ./reports:/reports
    profiles:
      - testing

networks:
  gateway-network:
    driver: bridge
